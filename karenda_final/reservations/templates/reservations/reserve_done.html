{% extends 'base.html' %}
{% load static %}

{% block title %}äºˆç´„å®Œäº† - karenda{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/completion.css' %}">
{% endblock %}

{% block content %}
    <div class="completion-container">
        <div class="completion-icon">âœ“</div>
        
        <h1 class="completion-title">äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ</h1>
        
        <p class="completion-subtitle">
            ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
            ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã€‚
        </p>

        <div class="card details-card">
            <div class="card-header">
                <h2>ã”äºˆç´„å†…å®¹</h2>
            </div>
            <div class="card-body">
                <div class="detail-row">
                    <span class="detail-label">äºˆç´„ç•ªå·</span>
                    <span class="detail-value" id="reservationId">
                        #{{ reservation.id }}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ãŠåå‰</span>
                    <span class="detail-value">
                        {{ reservation.name }}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">æ¥åº—æ—¥</span>
                    <span class="detail-value">
                        {{ reservation.date|date:"Yå¹´mæœˆdæ—¥" }}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">æ™‚é–“å¸¯</span>
                    <span class="detail-value">
                        {{ reservation.get_time_slot_display }}
                    </span>
                </div>
                {% if reservation.note %}
                    <div class="detail-row">
                        <span class="detail-label">ã”å‚™è€ƒ</span>
                        <span class="detail-value">
                            {{ reservation.note|linebreaks }}
                        </span>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="action-buttons">
            <a href="#" class="btn btn-secondary" id="addToCalendar">
                 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ 
            </a>
            <a href="{% url 'reserve' %}" class="btn btn-primary">
                æ–°ã—ã„äºˆç´„ã‚’ä½œæˆ
            </a>
        </div>

        <div class="info-section">
            <h3>ã”æ¥åº—å‰ã«ã”ç¢ºèªãã ã•ã„</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-icon">ğŸ“</span>
                    <div class="info-content">
                        <strong>ã”æ¥åº—æ™‚é–“</strong>
                        <p>äºˆç´„æ™‚é–“ã®5åˆ†å‰ã«ãŠè¶Šã—ãã ã•ã„</p>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-icon">ğŸ“</span>
                    <div class="info-content">
                        <strong>ã”é€£çµ¡å…ˆ</strong>
                        <p>ã”ä¸æ˜ãªç‚¹ã¯ã€ãŠæ°—è»½ã«ãŠé›»è©±ãã ã•ã„<br>TEL: 090-XXXX-XXXX</p>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-icon">âŒ</span>
                    <div class="info-content">
                        <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦</strong>
                        <p>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯äºˆç´„æ—¥ã®3æ—¥å‰ã¾ã§ã«ãŠé¡˜ã„ã—ã¾ã™</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation-links">
            <a href="{% url 'dashboard' %}">äºˆç´„ä¸€è¦§ã«æˆ»ã‚‹</a>
            <span class="separator">|</span>
            <a href="{% url 'cancel_reservation' reservation.pk %}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´</a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.getElementById('addToCalendar').addEventListener('click', function(e) {
            e.preventDefault();
            
            const reservationId = document.getElementById('reservationId').textContent;
            const date = '{{ reservation.date|date:"Ymd" }}';
            const timeSlot = '{{ reservation.get_time_slot_display }}';
            const name = '{{ reservation.name }}';
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//karenda//Reservation//EN
BEGIN:VEVENT
UID:${reservationId}@karenda.local
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${date}T100000Z
SUMMARY:karenda - äºˆç´„ (${timeSlot})
DESCRIPTION:äºˆç´„ç•ªå·: ${reservationId}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reservation_${reservationId}.ics`;
            link.click();
            window.URL.revokeObjectURL(url);
        });
    </script>
{% endblock %}
